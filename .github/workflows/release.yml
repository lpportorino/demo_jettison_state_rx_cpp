name: Build and Release AppImage

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-appimage:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Extract version
      id: extract_version
      run: |
        VERSION=$(cat VERSION | tr -d '[:space:]')
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          clang \
          clang-format \
          clang-tidy \
          git \
          pkg-config \
          libprotobuf-dev \
          protobuf-compiler \
          libwebsockets-dev \
          libssl-dev \
          nlohmann-json3-dev \
          wget \
          file \
          patchelf \
          desktop-file-utils \
          libfuse2

    - name: Build project
      run: |
        echo "Building jettison_state_rx..."
        mkdir -p build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_C_COMPILER=clang \
              -DCMAKE_CXX_COMPILER=clang++ \
              -DENFORCE_CHECKS=OFF \
              ..
        make -j$(nproc)
        echo "Binary built successfully"
        ls -lh jettison_state_rx
        file jettison_state_rx

    - name: Download AppImage tools
      run: |
        echo "Downloading linuxdeploy..."
        wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage

        echo "Downloading appimagetool..."
        wget -q https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage

        chmod +x *.AppImage
        ls -la *.AppImage

    - name: Create AppDir structure
      run: |
        echo "Creating AppDir structure..."
        rm -rf AppDir
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/lib
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/scalable/apps

        # Copy binary
        cp build/jettison_state_rx AppDir/usr/bin/
        chmod +x AppDir/usr/bin/jettison_state_rx

        # Copy desktop file
        cp .github/appimage-assets/jettison-state-rx.desktop AppDir/usr/share/applications/

        # Copy icon
        cp .github/appimage-assets/jettison-state-rx.svg AppDir/usr/share/icons/hicolor/scalable/apps/

        # Create AppRun launcher
        cp .github/appimage-assets/jettison-state-rx-launcher.sh AppDir/AppRun
        chmod +x AppDir/AppRun

        # Create symlinks at root
        ln -sf usr/share/applications/jettison-state-rx.desktop AppDir/
        ln -sf usr/share/icons/hicolor/scalable/apps/jettison-state-rx.svg AppDir/jettison-state-rx.svg

        echo "AppDir structure created"
        ls -la AppDir/

    - name: Deploy dependencies with linuxdeploy
      run: |
        echo "Deploying dependencies..."
        ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --executable AppDir/usr/bin/jettison_state_rx \
            --desktop-file AppDir/usr/share/applications/jettison-state-rx.desktop \
            --icon-file AppDir/usr/share/icons/hicolor/scalable/apps/jettison-state-rx.svg \
            --library /usr/lib/x86_64-linux-gnu/libwebsockets.so.17 \
            --library /usr/lib/x86_64-linux-gnu/libprotobuf.so.32 \
            --library /usr/lib/x86_64-linux-gnu/libssl.so.3 \
            --library /usr/lib/x86_64-linux-gnu/libcrypto.so.3 || true

        echo "Dependencies deployed"
        ls -la AppDir/usr/lib/

    - name: Fix library paths
      run: |
        echo "Fixing RPATH for bundled libraries..."
        for lib in AppDir/usr/lib/*.so*; do
            if [ -f "$lib" ] && file "$lib" | grep -q ELF; then
                echo "Fixing RPATH for $(basename "$lib")"
                patchelf --set-rpath '$ORIGIN:$ORIGIN/..' "$lib" 2>/dev/null || true
            fi
        done

        # Fix RPATH for the main binary
        patchelf --set-rpath '$ORIGIN/../lib:$ORIGIN/../lib/x86_64-linux-gnu' AppDir/usr/bin/jettison_state_rx || true

        echo "RPATH fixed"

    - name: Cleanup AppDir
      run: |
        echo "Cleaning up AppDir..."
        find AppDir -name "*.a" -delete
        find AppDir -name "*.la" -delete
        rm -rf AppDir/usr/share/man
        rm -rf AppDir/usr/share/doc
        rm -rf AppDir/usr/include

        echo "AppDir size:"
        du -sh AppDir/

    - name: Build AppImage
      run: |
        echo "Creating AppImage..."
        ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir \
          jettison-state-rx-${{ steps.extract_version.outputs.VERSION }}-linux-x86_64.AppImage

        echo "AppImage created successfully"
        ls -lh jettison-state-rx-*.AppImage

        # Make it executable
        chmod +x jettison-state-rx-*.AppImage

        # Test the AppImage
        echo "Testing AppImage..."
        ./jettison-state-rx-*.AppImage --help || true

    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: jettison-state-rx-AppImage
        path: jettison-state-rx-*.AppImage

  release:
    needs: build-appimage
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v'))

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download AppImage
      uses: actions/download-artifact@v4
      with:
        name: jettison-state-rx-AppImage

    - name: Extract version
      id: extract_version
      run: |
        VERSION=$(cat VERSION | tr -d '[:space:]')
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    - name: Generate release notes
      run: |
        cat > release_notes.md << EOF
        # Jettison State RX v${{ steps.extract_version.outputs.VERSION }}

        ## Changes
        ${{ github.event.head_commit.message }}

        ## Download
        - **Linux**: Download the AppImage below and make it executable

        ## Usage
        \`\`\`bash
        # Make executable
        chmod +x jettison-state-rx-*.AppImage

        # Run
        ./jettison-state-rx-*.AppImage sych.local
        ./jettison-state-rx-*.AppImage sych.local --dump 10
        ./jettison-state-rx-*.AppImage --read-dump dumps/state_0001.bin
        \`\`\`

        ## Security Warning
        ⚠️ **Dumps may contain sensitive data** including GPS coordinates and system information.

        ---
        Commit: ${{ github.sha }}
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.extract_version.outputs.VERSION }}
        name: Jettison State RX v${{ steps.extract_version.outputs.VERSION }}
        body_path: release_notes.md
        files: |
          jettison-state-rx-*.AppImage
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
